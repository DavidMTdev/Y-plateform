{% extends 'base.html.twig' %}
{% block title %}- Home {% endblock %}

{% block content %}
{# {{dump(like)}}
{{dump(dislike)}} #}

<p>{{game.name}}</p>
<img src="{{ asset('/gameImg/')}}{{game.img }}" alt="">
<p>{{game.descriptionG}}</p>
<p>{{note[0].note}}</p>
<button>telecharger</button>

{% for key,value in comments %}
<img src={{ asset('/avatar/')}}{{value.user.avatar }}"" alt="">
<p>{{value.user.pseudo}}</p>
<p>{{value.descriptionC}}</p>
<p>{{value.dateC.date|date("F jS \\a\\t g:ia") }}</p>


<a href="{{ path('comment_like', {'id' : value.id})}}" class="js-like">
    {% if app.user and value.isLikedByUser(app.user) and value.likeOrDislike(app.user)%}

    {# quand il n'y a pas de like c'est égal à 0 sinon longueur de liste#}
    {% if like[key][0] != "0" %}
    <i class="fas fa-thumbs-up" id="{{key}}j"><span class="js-likes">{{like[key] | length}}</span></i>
    {% else %}
    <i class="fas fa-thumbs-up" id="{{key}}j"><span class="js-likes">0</span></i>
    {% endif %}

    {% else %}

    {% if like[key][0] != "0" %}
    <i class="far fa-thumbs-up" id="{{key}}j"><span class="js-likes">{{like[key] | length}}</span></i>
    {% else %}
    <i class="far fa-thumbs-up" id="{{key}}j"><span class="js-likes">0</span></i>
    {% endif %}

    {% endif %}
</a>


<a href="{{ path('comment_dislike', {'id' : value.id})}}" class="js-like">
    {% if app.user and value.isLikedByUser(app.user) and value.likeOrDislike(app.user) == false %}

    {% if dislike[key][0] != "0" %}
    <i class="fas fa-thumbs-down" id="{{key}}j"><span class="js-dislikes">{{dislike[key] | length}}</span></i>
    {% else %}
    <i class="fas fa-thumbs-down" id="{{key}}j"><span class="js-dislikes">0</span></i>
    {% endif %}

    {% else %}

    {% if dislike[key][0] != "0" %}
    <i class="far fa-thumbs-down" id="{{key}}j"><span class="js-dislikes">{{dislike[key] | length}}</span></i>
    {% else %}
    <i class="far fa-thumbs-down" id="{{key}}j"><span class="js-dislikes">0</span></i>
    {% endif %}

    {% endif %}
</a>
{% endfor %}

{% if app.user != null %}

{{form_start(commentForm)}}


{{form_errors(commentForm)}}
{{form_widget(commentForm)}}

<button type="submit">ajouter un commentaire</button>
{{form_end(commentForm)}}
{% endif %}

{% endblock %}

{% block js %}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>

    function onClickBtnLike(event) {
        event.preventDefault() // permet de pas changer de page au click

        const url = this.href; // this qui est la balise <a> sur laquelle on click qui est definis dans le addEventListener
        const countLikes = this.querySelector('span.js-likes')
        const countDislikes = this.querySelector('span.js-dislikes')
        const icone = this.querySelector('i')
        const allIcones = document.querySelectorAll('i')

        axios.get(url).then(function (response) {
            if (countLikes != null) {
                const likes = response.data.likes
                countLikes.textContent = likes
            } else {
                const dislikes = response.data.dislikes
                countDislikes.textContent = dislikes
            }

            $boolean = false
            allIcones.forEach(element => {
                if (icone.classList.contains('far') && element.classList.contains('fas')) {
                    if (element.getAttribute('id') === icone.getAttribute('id')) {
                        $boolean = true;
                        element.classList.replace('fas', 'far')
                        icone.classList.replace('far', 'fas')
                        if (icone.classList.contains('fa-thumbs-down')) {
                            icone.textContent = response.data.dislikes
                            element.textContent = response.data.likes
                        } else {
                            icone.textContent = response.data.dislikes + 2
                            element.textContent = response.data.likes - 2
                        }

                    }
                }

            });
            if ($boolean === false) {
                if (icone.classList.contains('fas')) { // contains = contenir en frenchies, donc si l'icone contient la class 'fas'
                    icone.classList.replace('fas', 'far')
                } else {
                    icone.classList.replace('far', 'fas')
                }
            }








        }).catch(function (error) { // catch si il y'a une erreur, then si tout se pass bien
            if (error.response.status === 403) {
                window.alert("il faut être connecté pour liker")
            } else {
                window.alert("une erreur s'est produite, nos equipe travail la dessus")
            }
        })
    }

    document.querySelectorAll('a.js-like').forEach(function (link) {
        link.addEventListener('click', onClickBtnLike)
    })
</script>
{% endblock %}